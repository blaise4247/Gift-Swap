<style>
    /* ... (CSS from V19.0) ... */
    .share-btn { background: #25D366; color: white; margin-top: 10px; width: 100%; } /* WhatsApp Green */
    .sms-btn { background: #007AFF; color: white; padding: 5px 15px; border-radius: 8px; font-size: 0.8rem; } /* iMessage Blue */
</style>

<script>
    const app = {
        data: JSON.parse(localStorage.getItem('giftSwap_HubV20')) || {},
        activeId: null,

        // ... (init, navigate, setTheme, createGroup, renderHome, renderRows, updateP, renderEx, toggleEx, addPerson functions remain the same) ...

        generateMasterHub: async function() {
            this.data[this.activeId].name = document.getElementById('groupName').value;
            this.data[this.activeId].budget = document.getElementById('groupBudget').value;
            
            const group = this.data[this.activeId];
            const pp = group.participants.filter(p => p.name && p.name.trim());
            if (pp.length < 3) return alert("Min 3 names required!");

            let g = [...pp], r = [...pp], valid = false, att = 0;
            while(!valid && att < 3000) {
                att++; r.sort(() => Math.random() - 0.5);
                valid = g.every((v, i) => v.name !== r[i].name && !v.exclusions.includes(r[i].name));
            }
            if(!valid) return alert("Exclusion conflict!");

            const payload = btoa(unescape(encodeURIComponent(JSON.stringify({
                n: group.name, b: group.budget, m: g.map((v, i) => ({ g: v.name, r: r[i].name, w: r[i].wish }))
            }))));

            const hubUrl = window.location.origin + window.location.pathname + "?hub=" + payload;
            
            // --- NEW: WEB SHARE API ---
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Secret Santa: ${group.name}`,
                        text: `Hi everyone! Here is the link to our Secret Santa Hub for ${group.name}. Find your name to see your match!`,
                        url: hubUrl,
                    });
                } catch (err) {
                    console.log("Share cancelled or failed");
                }
            } else {
                navigator.clipboard.writeText(hubUrl);
                alert("Hub Link Copied! Send this to your group chat.");
            }
        },

        handleHub: function(encoded) {
            const data = JSON.parse(decodeURIComponent(escape(atob(encoded))));
            this.navigate('hub');
            document.getElementById('hubGroupName').innerText = data.n || "Secret Santa Hub";
            document.getElementById('hubBudget').innerText = data.b || "No Budget";
            const list = document.getElementById('hubList'); list.innerHTML = "";
            
            data.m.forEach(match => {
                const item = document.createElement('div'); item.className = 'hub-item';
                item.innerHTML = `<strong>${match.g}</strong> <button class="btn btn-primary" style="padding:5px 15px; font-size:0.8rem;">Reveal Match</button>`;
                item.onclick = () => {
                    document.getElementById('revGiver').innerText = match.g;
                    document.getElementById('revReceiver').innerText = match.r;
                    document.getElementById('revWishlist').innerText = match.w || "Nothing specific!";
                    const searchQuery = encodeURIComponent(`${match.w || ''} gifts under ${data.b || '25'}`);
                    document.getElementById('amzBtn').href = `https://www.amazon.com/s?k=${searchQuery}`;
                    document.getElementById('revealOverlay').style.display = 'flex';
                };
                list.appendChild(item);
            });
        },

        save: function() { localStorage.setItem('giftSwap_HubV20', JSON.stringify(this.data)); }
    };
    window.onload = () => app.init();
</script>
