<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftSwap | Cloud-Powered Secret Santa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #FCFAFA; --card: #FFFFFF; --text: #2D2D2D; --primary: #D0312D; --secondary: #1A3C34; --border: #E5E5E5; --input-bg: #FFFFFF; }
        [data-theme="dark-santa"] { --bg: #121212; --card: #1E1E1E; --text: #E0E0E0; --primary: #FF4545; --secondary: #00E676; --border: #333333; --input-bg: #2C2C2C; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; transition: 0.3s; }
        
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .logo { font-family: 'Mountains of Christmas', cursive; font-size: 1.8rem; color: var(--primary); cursor: pointer; }
        
        main { flex: 1; padding: 40px 5%; max-width: 1200px; margin: 0 auto; width: 100%; }
        section { display: none; animation: fadeIn 0.4s ease-out; }
        .active-section { display: block !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Auth Styles */
        .auth-card { background: var(--card); max-width: 400px; margin: 50px auto; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border); text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text); font-size: 1rem; }
        
        .btn { border: none; padding: 12px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; display: inline-block; }
        .btn-primary { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* Dashboard Styles */
        .groups-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .group-card { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 16px; cursor: pointer; position: relative; }
        .p-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 0.3fr; gap: 10px; margin-bottom: 10px; }
        .exclusion-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; max-height: 100px; overflow-y: auto; font-size: 0.8rem; }

        footer { padding: 30px; text-align: center; font-size: 0.8rem; opacity: 0.5; border-top: 1px solid var(--border); margin-top: auto; }
    </style>
</head>
<body>

    <nav>
        <div class="logo" onclick="location.reload()">GiftSwap</div>
        <div id="userDisplay" style="font-size: 0.9rem; font-weight: 600;"></div>
    </nav>

    <main>
        <section id="loginSection" class="active-section">
            <div class="auth-card">
                <h1 style="font-family:'Mountains of Christmas'; font-size: 2.5rem; color: var(--primary); margin-bottom: 10px;">GiftSwap</h1>
                <p style="margin-bottom: 25px; opacity: 0.7;">Secure Cloud Login</p>
                <input type="email" id="email" placeholder="Email Address">
                <input type="password" id="password" placeholder="Password">
                <button class="btn btn-primary" id="loginBtn">Log In</button>
                <button class="btn btn-outline" id="signUpBtn" style="width: 100%; margin-top: 10px;">Create New Account</button>
                <p id="authMessage" style="margin-top: 15px; font-size: 0.85rem; color: var(--primary);"></p>
            </div>
        </section>

        <section id="homeSection">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>My Exchanges</h1>
                <button class="btn btn-outline" onclick="app.logout()">Log Out</button>
            </div>
            <button class="btn btn-primary" style="width:auto; margin-top:20px;" onclick="app.createNewGroup()">+ Start New Group</button>
            <div id="groupsGrid" class="groups-grid"></div>
        </section>

        <section id="editorSection">
            <button class="btn btn-outline" onclick="app.showSection('home')" style="margin-bottom:20px;">‚Üê Back</button>
            <input type="text" id="editGroupName" style="font-size: 2rem; border: none; border-bottom: 2px solid var(--border); background: transparent; font-weight: 700; color: var(--secondary);" placeholder="Group Name">
            <div style="margin: 20px 0;">
                Budget: <input type="text" id="editBudget" style="width: 150px; display: inline-block;" placeholder="$25">
            </div>
            <div id="rowsContainer"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-outline" onclick="app.addRow()">+ Add Person</button>
                <button class="btn btn-primary" style="flex:1" onclick="app.generateAndShare()">üöÄ Save & Share Hub Link</button>
            </div>
        </section>

        <section id="hubSection">
            <div class="auth-card" style="max-width: 600px;">
                <h2 id="hubTitle" style="font-family:'Mountains of Christmas'; font-size: 2.5rem; color: var(--primary);"></h2>
                <p>Budget: <strong id="hubBudgetDisplay"></strong></p>
                <div id="hubList" style="margin-top: 30px; text-align: left;"></div>
            </div>
        </section>
    </main>

    <div id="revealOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center; color:white; text-align:center;">
        <div style="padding: 20px; width: 90%; max-width: 400px;">
            <h3>Hi <span id="revGiver"></span>! You are buying for:</h3>
            <h1 id="revReceiver" style="font-family:'Mountains of Christmas'; font-size: 3.5rem; color: var(--primary); margin: 20px 0;"></h1>
            <p id="revWishlist" style="font-style: italic; opacity: 0.8; margin-bottom: 30px;"></p>
            <a href="#" id="amzBtn" target="_blank" style="display:inline-block; background:#FF9900; padding:12px 25px; border-radius:10px; color:black; font-weight:bold; text-decoration:none;">Shop on Amazon</a>
            <br><button class="btn btn-outline" style="margin-top:30px; border-color:white; color:white;" onclick="document.getElementById('revealOverlay').style.display='none'">Close</button>
        </div>
    </div>

    <footer>&copy; 2026 GiftSwap ‚Ä¢ Built by Cameron Heinig</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } 
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, addDoc } 
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyATYhslQjwCuqQ7XJJzf7oZlQDYgoY_hOs",
            authDomain: "giftsswap.firebaseapp.com",
            projectId: "giftsswap",
            storageBucket: "giftsswap.firebasestorage.app",
            messagingSenderId: "930851561925",
            appId: "1:930851561925:web:2f86536101b8052c08ebac",
            measurementId: "G-EKLN661TLX"
        };

        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);

        const app = {
            currentUser: null,
            activeGroup: { name: "", budget: "", participants: [] },

            init: function() {
                // Check if we are viewing a shared hub
                const params = new URLSearchParams(window.location.search);
                const hub = params.get('hub');
                if (hub) return this.handleHub(hub);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.currentUser = user;
                        document.getElementById('userDisplay').innerText = user.email;
                        this.showSection('home');
                        this.loadUserGroups();
                    } else {
                        this.showSection('login');
                    }
                });

                this.bindEvents();
            },

            bindEvents: function() {
                document.getElementById('loginBtn').onclick = () => this.handleAuth('login');
                document.getElementById('signUpBtn').onclick = () => this.handleAuth('signup');
            },

            handleAuth: async function(type) {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const msg = document.getElementById('authMessage');
                try {
                    if(type === 'login') await signInWithEmailAndPassword(auth, email, password);
                    else await createUserWithEmailAndPassword(auth, email, password);
                } catch (e) { msg.innerText = e.message; }
            },

            logout: () => signOut(auth),

            showSection: function(id) {
                document.querySelectorAll('section').forEach(s => s.classList.remove('active-section'));
                document.getElementById(id + 'Section').classList.add('active-section');
            },

            createNewGroup: function() {
                this.activeGroup = { name: "Christmas 2026", budget: "$20", participants: [{name:"", wish:"", exclusions:[]},{name:"", wish:"", exclusions:[]},{name:"", wish:"", exclusions:[]}] };
                this.renderEditor();
                this.showSection('editor');
            },

            renderEditor: function() {
                document.getElementById('editGroupName').value = this.activeGroup.name;
                document.getElementById('editBudget').value = this.activeGroup.budget;
                const container = document.getElementById('rowsContainer');
                container.innerHTML = "";
                this.activeGroup.participants.forEach((p, i) => {
                    const r = document.createElement('div');
                    r.className = "p-row";
                    r.innerHTML = `
                        <input type="text" value="${p.name}" placeholder="Name" oninput="app.activeGroup.participants[${i}].name=this.value; app.renderExclusions(${i})">
                        <input type="text" value="${p.wish}" placeholder="Wishlist" oninput="app.activeGroup.participants[${i}].wish=this.value">
                        <div class="exclusion-box" id="ex-${i}"></div>
                        <button class="btn-outline" style="border-radius:8px;" onclick="app.activeGroup.participants.splice(${i},1); app.renderEditor();">√ó</button>
                    `;
                    container.appendChild(r);
                    this.renderExclusions(i);
                });
            },

            renderExclusions: function(idx) {
                const box = document.getElementById(`ex-${idx}`);
                if(!box) return;
                box.innerHTML = "";
                this.activeGroup.participants.forEach((p, i) => {
                    if(i !== idx && p.name.trim()) {
                        const checked = this.activeGroup.participants[idx].exclusions.includes(p.name) ? 'checked' : '';
                        box.innerHTML += `<label style="display:block;"><input type="checkbox" ${checked} onchange="app.toggleEx(${idx}, '${p.name}')"> ${p.name}</label>`;
                    }
                });
            },

            toggleEx: function(i, name) {
                const ex = this.activeGroup.participants[i].exclusions;
                if(ex.includes(name)) this.activeGroup.participants[i].exclusions = ex.filter(n => n !== name);
                else ex.push(name);
            },

            addRow: function() { this.activeGroup.participants.push({name:"", wish:"", exclusions:[]}); this.renderEditor(); },

            generateAndShare: async function() {
                const g = this.activeGroup;
                g.name = document.getElementById('editGroupName').value;
                g.budget = document.getElementById('editBudget').value;
                const pp = g.participants.filter(p => p.name.trim());
                
                if(pp.length < 3) return alert("Min 3 people!");

                // Generate Matches
                let buyers = [...pp], targets = [...pp], valid = false, att = 0;
                while(!valid && att < 3000) {
                    att++; targets.sort(() => Math.random() - 0.5);
                    valid = buyers.every((b, i) => b.name !== targets[i].name && !b.exclusions.includes(targets[i].name));
                }

                if(!valid) return alert("Conflicts! Try removing some exclusions.");

                const payload = btoa(unescape(encodeURIComponent(JSON.stringify({
                    n: g.name, b: g.budget, m: buyers.map((b, i) => ({ g: b.name, r: targets[i].name, w: targets[i].wish }))
                }))));

                const hubUrl = window.location.origin + window.location.pathname + "?hub=" + payload;
                
                // SAVE TO FIRESTORE
                await addDoc(collection(db, "groups"), { ...g, owner: this.currentUser.uid, timestamp: Date.now() });

                // SHARE
                if (navigator.share) {
                    await navigator.share({ title: g.name, url: hubUrl });
                } else {
                    navigator.clipboard.writeText(hubUrl);
                    alert("Link copied to clipboard! Send it to the group chat.");
                }
            },

            handleHub: function(encoded) {
                const data = JSON.parse(decodeURIComponent(escape(atob(encoded))));
                this.showSection('hub');
                document.getElementById('hubTitle').innerText = data.n;
                document.getElementById('hubBudgetDisplay').innerText = data.b;
                const list = document.getElementById('hubList');
                list.innerHTML = "";
                data.m.forEach(match => {
                    const item = document.createElement('div');
                    item.className = "hub-item";
                    item.innerHTML = `<strong>${match.g}</strong> <button class="btn btn-outline" style="padding:5px 10px;">Who do I have?</button>`;
                    item.onclick = () => {
                        document.getElementById('revGiver').innerText = match.g;
                        document.getElementById('revReceiver').innerText = match.r;
                        document.getElementById('revWishlist').innerText = match.w ? `They want: ${match.w}` : "No wishlist provided.";
                        document.getElementById('amzBtn').href = `https://www.amazon.com/s?k=${encodeURIComponent(match.w || 'secret santa gifts')}`;
                        document.getElementById('revealOverlay').style.display = 'flex';
                    }
                    list.appendChild(item);
                });
            },

            loadUserGroups: async function() {
                const q = query(collection(db, "groups"), where("owner", "==", this.currentUser.uid));
                const snap = await getDocs(q);
                const grid = document.getElementById('groupsGrid');
                grid.innerHTML = "";
                snap.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = "group-card";
                    card.innerHTML = `<h3>${data.name}</h3><p>${data.participants.length} Members</p>`;
                    grid.appendChild(card);
                });
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>
